<!DOCTYPE html>
<html>
    <!--列表的翻页 词条编辑的内容显示-->
    <?php
        include '../.phtml/vrfylogin.php';
    ?>
    <head>
        <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=0.75, minimum-scale=0.75, maximum-scale=0.75, user-scalable=no">
        <title>admin@debook.nawaski.com</title>
        <link rel="icon" href="../Image/debook.ico">
        <link rel="stylesheet" type="text/css" href="../css/main.css">
        <link rel="stylesheet" type="text/css" href="../css/table.css">
        <link rel="stylesheet" type="text/css" href="../css/input.css">
    </head>

    <body>
        <?php 
        $browser = browse_info();
        $admin = getArray($_SESSION,"admin_db_$browser");
        if($admin!=""){
            echo <<<WAITPAGE
                <div id="sectionCon" style="height:100%">
                    <div class="section" style="height:100%">
                        <div class="rcon">
                            <div class="pcon" style="text-align:left;">
                                <h2>正在为您登录...</h2>
                                <h4 style="margin: 10px 0px;"><a>admin@debook.nawaski.com</a></h4>
                                <span class='wait' style='width:16px;background-color:transparent;'></span>
                            </div>
                        </div>
                    </div>
                </div>
            WAITPAGE;
        }else{
            echo <<<LOGINPAGE
            <div class="MsgBox" style="top:-100%;"><div class="middle_area"></div></div>
            <div id="sectionCon" style="height:100%">
                <div class="section" style="height:100%">
                    <div class="rcon">
                        <div class="pcon">
                            <h2>登录到</h2>
                            <h4 style="margin-top: 10px;"><a>admin@debook.nawaski.com</a></h4>
                        </div>
                        <div class="pcon">
                            <form method="POST" id="form0">
                              <div class="row">
                                  <div class="asbox_con">
                                      <input class="asbox" id="adminUsr" name="adminUsr" onblur="boxstyle(this.parentElement,0)" onfocus="boxstyle(this.parentElement,1)" autocomplete="off">
                                      <p>&nbsp;用户名*</p>
                                  </div>
                              </div>
                              <div class="row">
                                <div class="asbox_con">
                                    <input class="asbox" id="adminPwd" name="adminPwd" onblur="boxstyle(this.parentElement,0)" onfocus="boxstyle(this.parentElement,1)" autocomplete="off" type="password">
                                    <p>&nbsp;密码*</p>
                                </div>
                              </div>
                              <div class="row" style="width:33%">
                                <div class="asbox_con" style="border-color: rgb(196, 196, 196); background-color: rgb(250, 251, 252);width:auto">
                                    <button type="button" class="asbox_submit" autocomplete="off" style="width:auto" id="submit0">继续</button>
                                </div>
                              </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            LOGINPAGE;
        }
        ?>
    </body>

    <style>
        body{
            position:relative;
            float:left;
            text-align: center;
            width:100%;
            height:100%;
            font-family: consolas;
        }

        div#sectionCon>.section>div:nth-child(1){
            margin: auto;
            top:48%;
            transform: translateY(-50%);
            max-width: 440px;
        }

        div.pcon{
            width:80%;
            margin:0px 10%;
            margin-bottom: 15px;
        }

        form>div.row{
            margin:0px;
            width:98%;
            margin-bottom: 10px;
        }

        form>div.row input.asbox{
            padding:0px 2.8%;
            width:94.4%;
        }

        div.asbox_con button.asbox_submit {
            border-left: 1px solid #c4c4c4;
        }

        button.asbox_submit {
            position: relative;
            float: left;
            width: inherit;
            height: 28px;
            border: 0px;
            padding: 3px 4px 3px 3px;
            cursor: pointer;
            font-size: 17px;
            background-color: #0366d6;
            -webkit-appearance: none;
            border-radius: 0px;
            color: white;
            outline: 0px;
            transition: background-color 150ms ease 0s;
        }

        button.asbox_submit:active{
            background-color: #454545;
        }

        button[disabled]{
            background-color: #1f1f1f;
            color:#c4c4c4;
        }

        span.wait{
            background-image:url('Image/src/ajax_clock_small.gif');
            position:relative;
            width:16px;
            height:16px;
            margin:-2px;
            margin-left: 0px;
            image-rendering:-webkit-optimize-contrast;
            display: inline-block;
            background-position: left;
            background-repeat: no-repeat;
        }

          /*msgbox*/
        div.MsgBox
		{
			position:fixed;
			float:left;
			width:auto;
            left:50%;
			width:480px;
            margin-left: -240px;
			height:auto;
			max-height:360px;
			filter:drop-shadow(0px 0px 2.5px #aaa);
			background-color:#efefef;
            z-index: 20;
            transition:all 0.8s ease 0s;
            text-align: left;
		}

        div.MsgBox a.btn{
            font-size: 15px;
            padding: 1px 3px;
            margin: .3% 0px;
            margin-left: 6px;
        }
		
		div.middle_area
		{
			position: relative;
			float: left;
			width: 97%;
			height: auto;
			margin: 1% 1.5%;
		}

        .MsgBox *{
            position:relative;
            float:left;
            height:auto;
        }

        div.MsgBox *[right]{
            float:right;
        }

        .MsgBox b,.MsgBox i,.MsgBox font,.MsgBox text,.MsgBox span,.MsgBox u{
            position:relative;
            float:none;
            height:auto;
        }

        .break{
            width:100%;
            height:1px;
            background-color: #bdbdbd;
            margin:2px 0px;
        }

        *[autofill]{
            float:right;
            width:-webkit-fill-available;
            width:-moz-available;
            width:-o-available;
        }

        *[small-text]{
            font-size:14px;
            margin: 2px 0px;
        }

        *[smaller-text]{
            font-size:12px;
            margin: 1px 0px;
            float:right;
        }

        div[progress-bar]{
            height:6px;
            margin:4px 0px;
            border-radius:4px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        div[progress-bar]>div{
            height:100%;
            border-radius: 3px;
            background-color: #0071E3;
            background-image:-webkit-linear-gradient(left, #0071E3 10%, #2196f3 50%,#1e88e5 100%);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            -webkit-box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }

        html{
            height:100%;
        }
    </style>

    <script type="text/javascript" src="../script/usr.js"></script>
    <script type="text/javascript" src="../script/table.js"></script>
    <script type="text/javascript" src="../script/jquery.1.7.2.js"></script>
    <script type="text/javascript" src="../script/jquery.base64.js"></script>
    <script type="text/javascript" src="../script/jquery.md5.js"></script>
    <script type="text/javascript" src="../script/download.js"></script>
    <script type="text/javascript" src="../script/utils.js"></script>
    <script>
        var global_adminUsr = "";
        var meroot = "";
        var defaultOpt = "<a onclick=\"absGoTo('')\">debook.nawaski.com/</a>";
        var upperLevel = "<a>返回上一级</a>";

        if(navigator.userAgent.indexOf("MSIE")>=0||document.all){
            window.location = "../compatibility.html";
        }

        window.onscroll = function(){localStorage.setItem(navigator.platform + "_db_adminPage_scrollY",window.scrollY);}
        window.onresize = function(){};
        window.onload = function(){
            //login
            var submit0 = document.getElementById("submit0");
            var pwd0 = document.getElementById('adminPwd');
            var login = function(){
                newXMLHttpRequest('POST','../.phtml/vrfylogin.php','direct=phpAdmin',function(adminUsr){
                    newXMLHttpRequest('POST','admin.inside.html','allow=1',function(rspt){
                        document.body.innerHTML = rspt;
                        document.body.style.height = "";
                        global_adminUsr = adminUsr;
                        //changeStyle
                        var seccon = document.getElementById("sectionCon");
                        seccon.children[0].style.height = "auto";
                        seccon.children[1].style.marginBottom = "20px";
                        //regain height
                        var d = localStorage.getItem(navigator.platform + "_db_adminPage_scrollY");
                        if(d!=null&&typeof d!="undefined"){
                            window.scrollTo(0,d);
                        }
                        var d2 = localStorage.getItem(navigator.platform + "_db_adminPage_item");
                        if(d2!=null&&typeof d2!="undefined"){
                            adminSel(d2);
                        }
                        //initializeTable
                        myInitTable();
                        window.onresize = function(){resize2();};
                        resize2();
                        initVar();
                        initPath();
                        window.setTimeout(function(){
                            resize2();
                        },1);
                    },function(stobj){
                        netFatal(stobj);
                    });
                },function(){
                    netFatal(stobj);
                });
            }
            if(submit0!=null&&typeof submit0!="undefined"){
                setContinue();
            }else{
                login();
            }
            //load resize();
        }

        function initVar(){
            var ind = document.getElementById("pathIndicator");
            defaultOpt = ind.children[0].outerHTML;
            upperLevel = ind.children[1].outerHTML;
        }

        function myInitTable(){
            initTable(document.getElementById("fbkinfo_table"));
            initTable(document.getElementById("labels_table"));
            initTable(document.getElementById("msginfo_table"));
            initTable(document.getElementById("coninfo_table"));
            initTable(document.getElementById("files_table"));
        }

        function initPath(){
            if(window.location.hash!=""){
                var pf = window.location.hash;
                pf = pf.substring(1,pf.length);
                if(pf.indexOf("..")>=0) return;
                if(pf.charAt(pf.length-1)=="/"){
                    absGoTo(pf.substring(0,pf.length-1));
                }else{
                    pusState("#" + pf);
                    absGoTo(pf.substring(0,pf.lastIndexOf("/")),0);
                    fopen(pf.substring(pf.lastIndexOf("/")+1),pf.length,0);
                }
            }
        }

        function boxstyle(obj,index){
            if(!index){
                obj.style.boxShadow = "";
                obj.style.borderColor = "";
                obj.style.backgroundColor = "";
            }else{
                obj.style.boxShadow = "#c5e1a5 0.1px 0.1px 2px 3px";
                obj.style.borderColor = "#228b22";
                obj.style.backgroundColor = "#ffffff";
            }
        }

        function resize2(){}

        function setContinue(){
            var submit0 = document.getElementById("submit0");
            var pwd0 = document.getElementById('adminPwd');
            submit0.onclick = function(){continuea();};
            pwd0.onkeydown = function(ec){
                var e = ec || window.event;
                if(e.keyCode==10||e.keyCode==13){
                    submit0.onclick();
                }
            }
        }

        function lockForm(t){
            var u = document.getElementById("adminUsr");
            var p = document.getElementById("adminPwd");
            var submit0 = document.getElementById("submit0");
            if(t){
                u.setAttribute("disabled","");
                p.setAttribute("disabled","");
                submit0.setAttribute("disabled","");
            }else{
                u.removeAttribute("disabled");
                p.removeAttribute("disabled");
                submit0.removeAttribute("disabled");
            }
        }

        //未添加日志功能
        function continuea(){
            var msgbox = document.getElementsByClassName("MsgBox")[0];
            var form = document.getElementById("form0");
            var adminUsr = document.getElementById("adminUsr").value;
            var adminPwd = document.getElementById("adminPwd").value;
            var submit0 = document.getElementById("submit0");
            submit0.style.backgroundColor = "#efefef";
            submit0.innerHTML = '<span class="wait" style="width:11px;padding-left: 6px;background-color:whitesmoke;background-position: 2px;"></span>';
            lockForm(1);
            var realLogin = function(usr,pwd,admStatus){
                newXMLHttpRequest('POST','../.phtml/vrfylogin.php','direct=adminLogin&admin=' + usr,function(){
                    newXMLHttpRequest('POST','admin.inside.html','allow=1',function(rspt){
                        document.body.innerHTML = rspt;
                        document.body.style.height = "";
                        global_adminUsr = adminUsr;
                        //changeStyle
                        var seccon = document.getElementById("sectionCon");
                        seccon.children[0].style.height = "auto";
                        seccon.children[1].style.marginBottom = "20px";
                        window.onresize = function(){resize2();};
                        resize2();
                        initPath();
                    },function(stobj){
                        netFatal(stobj);
                        lockForm(0);
                    });
                },function(stobj){
                    netFatal(stobj);
                    lockForm(0);
                });
            };
            newXMLHttpRequest('POST','../.phtml/usr.php','key=adminLogin&usr=' + adminUsr + '&pwd=' + adminPwd,function(rspt){
                var mb = document.getElementsByClassName("MsgBox")[0];
                if(rspt=="ERR_USR_NOT_FOUND"||rspt=="ERR_NOT_AUTHORIZED"){
                  showMsgbox(mb,'<h3 style="width:100%">用户名或密码错误</h3><p style="width:100%">您的用户名或密码错误，请检查并更改后重试。</p><div class="line" style="margin-top: 5px;"></div><a class="btn" onclick="hideMsgbox(this.parentElement.parentElement)" right>知道了</a>');
                  lockForm(0);
                  submit0.style.backgroundColor = "#0366d6";
                  submit0.innerHTML = '继续';
                }else if(rspt=="ERR_UNDER_PRIVILEDGE"){
                  showMsgbox(mb,'<h3 style="width:100%">没有管理员权限</h3><p style="width:100%">您所使用的用户没有权限访问管理员页面，要了解更多，请联系管理员。</p><div class="line" style="margin-top: 5px;"></div><a class="btn" onclick="hideMsgbox(this.parentElement.parentElement)" right>知道了</a>');
                  lockForm(0);
                  submit0.style.backgroundColor = "#0366d6";
                  submit0.innerHTML = '继续';
                }else if(rspt=="1"){
                  realLogin();
                }
            },function(stobj){
                netFatal(stobj);
                submit0.style.backgroundColor = "#0366d6";
                submit0.innerHTML = '继续';
            });
        }

        function updateLabel(changeId){
            var structureTable = {
                localTableName:"labels_table",
                databaseTableName:"lblinfo",
                tableFunction:"修改标签|updateLabel:删除标签|removeLabel",//名称|函数名
                tableIdName:"labelid",
                dataNames:["label_name"],
                dataDisplayName:["标签"]
            }
            var msgbox = document.getElementsByClassName("MsgBox")[0];
            var noticeHTML = "<h3 style='margin-bottom:5px;width:100%'>标签的添加或更改</h3><p>填写要添加或更改的标签</p>";
            showUpdateTable(structureTable,msgbox,noticeHTML,changeId);
        }

        function removeLabel(changeId){
            var structureTable = {
                localTableName:"labels_table",
                databaseTableName:"lblinfo",
                tableFunction:"修改标签|updateLabel:删除标签|removeLabel",//名称|函数名
                tableIdName:"labelid",
                dataNames:["label_name"],
                dataDisplayName:["标签"]
            }
            if(changeId!=null){
                removeTable(structureTable,changeId);
            }
        }

        function removeLabels(){
            var d = confirm("确认删除选中的标签？");
            if(d) removeLabel(document.getElementById("labels_table").getAttribute("data"));
        }

        function updateMsg(changeId){
            var structureTable = {
                localTableName:"msginfo_table",
                databaseTableName:"msginfo",
                tableFunction:"修改通知|updateMsg:删除通知|removeMsg",//名称|函数名
                tableIdName:"msgid",
                dataNames:["innerHTML","status"],
                dataDisplayName:["通知内容",'启用状态']
            }
            var msgbox = document.getElementsByClassName("MsgBox")[0];
            var noticeHTML = "<h3 style='margin-bottom:5px;width:100%'>通知的添加或更改</h3><p>填写要添加或更改的通知</p>";
            showUpdateTable(structureTable,msgbox,noticeHTML,changeId);
        }
        
        function removeMsg(changeId){
            var structureTable = {
                localTableName:"msginfo_table",
                databaseTableName:"msginfo",
                tableFunction:"修改通知|updateMsg:删除通知|removeMsg",//名称|函数名
                tableIdName:"msgid",
                dataNames:["innerHTML","status"],
                dataDisplayName:["通知内容",'启用状态']
            }
            if(changeId!=null){
                removeTable(structureTable,changeId);
            }
        }

        function removeMsgs(){
            var d = confirm("确认删除选中的通知？");
            if(d) removeMsg(document.getElementById("msginfo_table").getAttribute("data"));
        }

        //feedback table indicating
        function showFeedbackTable(arg){
            var table = document.getElementById("fbkinfo_table");
            var tbody = table.children[1];
            showWait();
            var q = "adminkey=viewfbk";
            if(arg==null){
            }else if(arg.toLocaleLowerCase()=="waiting"){
                q += "&status=0";
            }else if(arg.toLocaleLowerCase()=="done"){
                q += "&status=1";
            }else if(arg.toLocaleLowerCase()=="ignored"){
                q += "&status=2";
            }
            newXMLHttpRequest('POST','../.phtml/admin.php',q,function(rspt){
                var nrspt = JSON.parse(rspt);
                tbody.innerHTML = "";
                if(nrspt.length==0){
                    tbody.innerHTML += '<tr empty><td colspan="5" style="text-align: center;background-color: #f2f4f6;">(没有任何反馈)</td></tr>';
                }else{
                    for(var i=0;i<nrspt.length;i++){
                        var id = nrspt[i]["fbkid"];
                        var fbk = decodeInfo(nrspt[i]["content"]);
                        var quesPos = fbk["location"].indexOf("?");
                        var search_hash = quesPos<0?"":fbk["location"].substr(quesPos+1);
                        var hashPos = fbk["location"].indexOf("#");
                        var hash = hashPos<0?"":fbk["location"].substr(hashPos+1);
                        var search = search_hash.substr(0,hashPos<0?search_hash.length-hash.length:search_hash.length-hash.length-1);
                        if(search==""){
                            fbk["location2"]="Home";
                        }else{
                            fbk["location2"] = fbk["location"];
                        }
                        var feedbackContent = "<div>网址: <a target='_blank' href='../"+fbk["location"]+"'>"+fbk["location2"]+"</a>"+"<br/>问题: "+fbk["problem"]+"</div>";
                        var feedbackDate = getDateInChinese(nrspt[i]["date"]*1000);
                        var feedbackContactWay = nrspt[i]["contributor"];
                        var status = nrspt[i]["status"];
                        var tdinf = [feedbackContent,feedbackDate,feedbackContactWay];
                        var tr = document.createElement("tr");
                        tr.setAttribute("id",id);
                        var tdInput = document.createElement("td");
                        var input = document.createElement("input");
                        var span = document.createElement("span");
                        input.setAttribute("type","checkbox");
                        input.setAttribute("class","asbox");
                        input.setAttribute("onclick","edSelect(this)");
                        tdInput.appendChild(input);
                        tdInput.appendChild(span);
                        tr.appendChild(tdInput);
                        for(var x=0;x<3;x++){
                            var h = document.createElement('td');
                            h.innerHTML = tdinf[x];
                            h.setAttribute("onclick","edSelect(this.parentElement.children[0].children[0],1)");
                            tr.appendChild(h);
                        }
                        var tdoptn = document.createElement("td");
                        if(status==0){
                            var optnBtn = document.createElement("a");
                            var reply_email = nrspt[i]["contributor"].indexOf("!")>=0?"":nrspt[i]["contributor"];
                            optnBtn.setAttribute("onclick","sendFbk('" + id + "','" + reply_email + "')");
                            optnBtn.innerHTML = "处理";
                            tdoptn.appendChild(optnBtn);
                            tdoptn.innerHTML += " | ";
                            var optnBtn2 = document.createElement("a");
                            optnBtn2.setAttribute("onclick","ignoreFbk('" + id + "')");
                            optnBtn2.innerHTML = "忽略";
                            tdoptn.appendChild(optnBtn2);
                        }else{
                            tdoptn.innerHTML = "（无可用操作）";
                        }
                        tr.appendChild(tdoptn);
                        tbody.appendChild(tr);
                    }
                }
                hideWait();
            },function(err){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
            });   
        }

        function sendFbk(id,email){
            showWait();
            newXMLHttpRequest("POST","../.phtml/admin.php","adminkey=sendFbk&id="+id+"&email="+email,function(){
                var status = ["","waiting","done","ignored"];
                var dom = document.getElementById("fbktablebar").children;
                var index = -1;
                for(var i=0;i<dom.length;i++){if(dom[i].hasAttribute("sel")) index = i;}
                showFeedbackTable(status[index]);
            },function(){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
            });
        }

        function ignoreFbk(id){
            showWait();
            newXMLHttpRequest("POST","../.phtml/admin.php","adminkey=ignoreFbk&id="+id,function(){
                var status = ["","waiting","done","ignored"];
                var dom = document.getElementById("fbktablebar").children;
                var index = -1;
                for(var i=0;i<dom.length;i++){if(dom[i].hasAttribute("sel")) index = i;}
                showFeedbackTable(status[index]);
            },function(){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
            });
        }

        function fbksel(obj){
            index = in_array(obj.parentElement.children,obj);
            for(var i=0;i<obj.parentElement.children.length;i++){
                if(i==index){
                    obj.parentElement.children[i].setAttribute("sel","");
                }else{
                    obj.parentElement.children[i].removeAttribute("sel");
                }
            }
        }

        //contribution table indicating
        function showContributionTable(arg){
            var table = document.getElementById("coninfo_table");
            var tbody = table.children[1];
            showWait();
            var q = "adminkey=viewcon";
            if(arg==null){
            }else if(arg.toLocaleLowerCase()=="waiting"){
                q += "&status=0";
            }else if(arg.toLocaleLowerCase()=="done"){
                q += "&status=1";
            }else if(arg.toLocaleLowerCase()=="ignored"){
                q += "&status=2";
            }
            for(var i=1;i<tbody.children.length;i++){
                tbody.children[i].outerHTML = "";
            }
            newXMLHttpRequest('POST','../.phtml/admin.php',q,function(rspt){
                var nrspt = JSON.parse(rspt);
                tbody.innerHTML = ""; 
                if(nrspt.length==0){
                    tbody.innerHTML += '<tr empty=""><td colspan="6" style="text-align: center;background-color: #f2f4f6;">(没有任何贡献)</td></tr>';
                }else{
                    for(var i=0;i<nrspt.length;i++){
                        var id = nrspt[i]["conid"];
                        var feedbackContent = "<a onclick=\"showCon('" + id + "')\">显示内容</a>";
                        var feedbackDate = getDateInChinese(nrspt[i]["date"]*1000);
                        var rdcw = decodeInfo(nrspt[i]["contributor"])["email"];
                        var feedbackContactWay = rdcw;
                        var status = nrspt[i]["status"];
                        var ip = nrspt[i]["ip"];
                        var tdinf = [feedbackContent,ip,feedbackDate,feedbackContactWay];
                        var tr = document.createElement("tr");
                        tr.setAttribute("id",id);
                        var tdInput = document.createElement("td");
                        var input = document.createElement("input");
                        var span = document.createElement("span");
                        input.setAttribute("type","checkbox");
                        input.setAttribute("class","asbox");
                        input.setAttribute("onclick","edSelect(this)");
                        tdInput.appendChild(input);
                        tdInput.appendChild(span);
                        tr.appendChild(tdInput);
                        for(var x=0;x<4;x++){
                            var h = document.createElement('td');
                            h.innerHTML = tdinf[x];
                            if(x!=0){
                                h.setAttribute("onclick","edSelect(this.parentElement.children[0].children[0],1)");
                            }
                            tr.appendChild(h);
                        }
                        var tdoptn = document.createElement("td");
                        var optnBtn = document.createElement("a");
                            optnBtn.innerHTML = (status=="0")?"处理":"";
                            optnBtn.setAttribute("href","javascript:showCon('" + id + "');");
                            if(status=="0"){
                                tdoptn.appendChild(optnBtn);
                            }else{
                                tdoptn.innerHTML = "（无可用操作）";
                            }
                        tr.appendChild(tdoptn);
                        tbody.appendChild(tr);
                    }
                }
                hideWait();
            },function(err){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
            });   
        }

        function toDig(num,len){
            if(len==null){
                len=2;
            }
            var str = String(num);
            var t = len - str.length;
            for(var i=0;i<t;i++){
                str = "0" + str;
            }
            return str;
        }

        function getDateInChinese(myDateInt){
            var d = new Date(myDateInt);
            return d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate() + " " + toDig(d.getHours()) + ":" + toDig(d.getMinutes()) + ":" + toDig(d.getSeconds());
        }

        function getTime(intd){
            var i = new Date(intd);
            var toDig = function(intk,len){
                var d = toString(intk);
                if(d.length!=len){
                    while(d.length<len){
                        d = "0" + d;
                    }
                }
                return d;
            }
            return toDig(i.getHours(),2) + ":" + toDig(i.getMinutes(),2) + ":" + toDig(i.getSeconds(),2);
        }

        function goTo(path){
            meroot += path + "/";
            showWait();
            newXMLHttpRequest("POST","../.phtml/more/readDir.mode.phtml","key=getFileTable&path=" + meroot,function(rspt){
                var data = JSON.parse(rspt);
                var table = document.getElementById("files_table");
                var trs= table.children[1].children;
                for(var i=trs.length-1;i>=0;i--){
                    trs[i].outerHTML = "";
                }
                for(var i=0;i<data.length;i++){
                    table.children[1].innerHTML += '<tr id="' + data[i]["filename"] + '""><td><input type="checkbox" class="asbox" onclick="edSelect(this)"><span></span></td><td onclick="edSelect(this.parentElement.children[0].children[0],1)"><div class="tb_icon" style="background-image:url(&quot;../Image/fatcow/' + data[i]["icon"] + '&quot;)"></div></td><td><a href="javascript:;" onclick="' + data[i]["cmd"] + '">' + data[i]["filename"] + '</a></td><td onclick="edSelect(this.parentElement.children[0].children[0],1)">' + data[i]["filetype"] + '</td><td onclick="edSelect(this.parentElement.children[0].children[0],1)">' + data[i]["filedate"] + '</td><td><a href="javascript:;">(空)</a></td></tr>';
                }
                if(data.length==0){
                    table.children[1].innerHTML += '<tr empty=""><td colspan="6" style="text-align: center;background-color: #f2f4f6;">(没有文件/文件夹)</td></tr>';
                }
                showNowPath(meroot);
                hideWait();
            },function(err){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
            });
        }

        function absGoTo(abspath,echoPath){
            meroot = abspath + "/";
            showWait();
            newXMLHttpRequest("POST","../.phtml/more/readDir.mode.phtml","key=getFileTable&path=" + meroot,function(rspt){
                var data = JSON.parse(rspt);
                if(rspt!="{}"){
                    var table = document.getElementById("files_table");
                    var trs= table.children[1].children;
                    for(var i=trs.length-1;i>=0;i--){
                        trs[i].outerHTML = "";
                    }
                    for(var i=0;i<data.length;i++){
                        table.children[1].innerHTML += '<tr id="' + data[i]["filename"] + '""><td><input type="checkbox" class="asbox" onclick="edSelect(this)"><span></span></td><td onclick="edSelect(this.parentElement.children[0].children[0],1)"><div class="tb_icon" style="background-image:url(&quot;../Image/fatcow/' + data[i]["icon"] + '&quot;)"></div></td><td><a href="javascript:;" onclick="' + data[i]["cmd"] + '">' + data[i]["filename"] + '</a></td><td onclick="edSelect(this.parentElement.children[0].children[0],1)">' + data[i]["filetype"] + '</td><td onclick="edSelect(this.parentElement.children[0].children[0],1)">' + data[i]["filedate"] + '</td><td><a href="javascript:;">(空)</a></td></tr>';
                    }
                    if(data.length==0){
                        table.children[1].innerHTML += '<tr empty=""><td colspan="6" style="text-align: center;background-color: #f2f4f6;">(没有文件/文件夹)</td></tr>';
                    }
                    showNowPath(meroot,echoPath);
                }else{
                    alert("指定的路径不存在。");
                    meroot = "/";
                }
                hideWait();
            },function(err){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
            });
        }

        function showNowPath(path,echoPath){
            var ind = document.getElementById("pathIndicator");
            if(echoPath!=null){
                if(echoPath!=0){
                    history.pushState("","","#" + path);
                }
            }else{
                history.pushState("","","#" + path);
            }
            ind.innerHTML = "当前路径：";
            ind.innerHTML += defaultOpt;
            var labels = path.split("/");
            var pathd = "";
            for(var i=0;i<labels.length;i++){
                if(labels[i]!=""){
                    var a = document.createElement("a");
                    pathd += labels[i];
                    a.setAttribute("onclick","absGoTo('" + pathd + "')");
                    a.href="javascript:;";
                    a.innerText = labels[i] + "/";
                    ind.appendChild(a);
                    pathd += "/";
                }
            }
            pathd = pathd.substr(0,pathd.lastIndexOf("/"));
            pathd = pathd.substr(0,pathd.lastIndexOf("/"));
            ind.innerHTML += upperLevel;
            ind.children[ind.children.length-1].setAttribute("onclick","absGoTo('" + pathd + "')");
        }

        function fopen(path,echoPath){
            if(echoPath==null) echoPath = 1;
            var root = "http://" + location.hostname + "/db.cn/";
            var view_panel = document.getElementById("view_panel");
            var view_box = document.getElementById("view_box");
            var filename = path.substring(path.lastIndexOf("/"),path.length);
            view_panel.children[0].children[0].children[0].innerHTML = filename;
            view_panel.style.zIndex = 2;
            view_panel.style.display = "block";
            document.body.style.overflow = "hidden";
            //提取文件类型
            var s = function(filename){
                return filename.substring(filename.lastIndexOf(".")+1,filename.length).toLocaleLowerCase();
            }
            //文件类型
            var video = ["mp4","mov","amv","avi","flv","m4v","mkv","webm"];
            var music = ["mp3","flac","m4a","m4b","m4p","wma","wav"];
            var pictures = ["jpg","jpeg","png","bmp","tiff","gif","ico","icns","svg"];
            var txt = ["txt","h","cpp","js","css","htm","html","phtml","php","php3","java","xml","vb","c",".out"];
            //判断文件类型
            if(txt.indexOf(s(filename))>=0){
                newXMLHttpRequest("POST",'../.phtml/more/readDir.mode.phtml','key=fopen&file=' + meroot + path,function(rspt){
                    var view_box = document.getElementById("view_box");
                    view_box.children[0].setAttribute("style","display:none");
                    view_panel.setAttribute("text-mode","");
                    var nrspt = "";
                    for(var i=0;i<rspt.length;i++){
                        if(rspt[i]=="<"){
                            nrspt+="&lt;";
                        }else if(rspt[i]==">"){
                            nrspt+="&gt;";
                        }else  if(rspt[i]=="'"||rspt[i]=='"'){
                            nrspt+="&quot;";
                        }else{
                            nrspt+=rspt[i];
                        }
                    }
                    var c = document.createElement("pre");
                    c.innerHTML = nrspt;
                    view_box.appendChild(c);
                    view_panel.children[0].children[0].children[1].children[0].onclick = function(){
                        download(rspt,filename,"*.*/File")
                    }
                },function(err){
                    alert("没有连接网络，请确保联网后再试一次。");
                });
            }else if(pictures.indexOf(s(filename))>=0){
                var img = document.createElement("img");
                view_box.children[0].setAttribute("style","display:none");
                img.src = root + meroot + path;
                view_box.appendChild(img);
                var a = view_panel.children[0].children[0].children[1].children[0];
                a.setAttribute("href",root + meroot + path);
                a.setAttribute("download",filename);
            }
            else if(video.indexOf(s(filename))>=0){
                var video = document.createElement("video");
                view_box.children[0].setAttribute("style","display:none");
                video.src = root + meroot + path;
                video.setAttribute("controls","controls");
                video.setAttribute("preload","");
                view_box.appendChild(video);
                var a = view_panel.children[0].children[0].children[1].children[0];
                a.setAttribute("href",root + meroot + path);
                a.setAttribute("download",filename);
            }else if(music.indexOf(s(filename))>=0){
                var video = document.createElement("audio");
                view_box.children[0].setAttribute("style","display:none");
                video.src = root + meroot + path;
                video.setAttribute("controls","controls");
                video.setAttribute("preload","");
                view_box.appendChild(video);
                var a = view_panel.children[0].children[0].children[1].children[0];
                a.setAttribute("href",root + meroot + path);
                a.setAttribute("download",filename);
            }else{
                view_box.children[0].setAttribute("style","display:none");
                var d = document.createElement("h3");
                var a = view_panel.children[0].children[0].children[1].children[0];
                d.innerHTML = "不支持查看此类型文件，您可以选择下载后查看。";
                view_box.appendChild(d);
                a.setAttribute("href",root + meroot + path);
                a.setAttribute("download",filename);
            }
            if(echoPath){
                pusState(pusState("#" + meroot + path));
            }
        }

        function pusState(str){
            history.pushState("","",str);      
        }

        function uploadFile(){
            var msgbox = document.getElementsByClassName("MsgBox")[1];
            showMsgbox(msgbox,'<h3 style="margin-bottom:5px;width:100%">上传文件</h3><p>上传单个或多个文件</p><style> div.asbox_con{margin-bottom:5px;} div.asbox_con:last-child{margin-bottom:0px;}</style><div class="line" style="margin-top: 5px;"></div><div class="asbox_con" style="width: calc(100% - 2px);"><p tips="" style="position: absolute;display: block;font-size: 16px;margin: 3px 0;"><span style="float: left;width: 24px;height: 24px;margin: 0 0 0 5px;background-size: contain;background-image:url(&quot;../Image/fatcow/folder.png&quot;)"></span>&nbsp;从本地选择文件</p><input type="file" class="asbox" onfocus="boxstyle(this.parentElement,1)" onblur="boxstyle(this.parentElement,0)" autocomplete="off" multiple style="opacity: 0;width: 100%;"></div><div class="line" style="margin-top: 5px;"></div><a class="btn" right="" onclick="hideMsgbox(this.parentElement.parentElement)">取消</a><a class="btn" right="">上传</a>');
            var input = msgbox.children[0].getElementsByTagName("input")[0];
            input.onchange = function(){
                var p = msgbox.getElementsByTagName("p")[1];
                var img = p.children[0].outerHTML;
                p.innerHTML = img + "准备上传"+this.files.length+"个文件";
            }
            var btn = msgbox.children[0].lastElementChild;
            var lstbtn = msgbox.children[0].children[msgbox.children[0].children.length-2];
            btn.onclick = function(){
                if(input.files.length>0){
                    lstbtn.onclick = function(){hideFileUploader(msgbox)};
                    lstbtn.innerHTML = "隐藏";
                    var formData = new FormData();
                    for(var i=0;i<input.files.length;i++){
                        formData.append("files[]",input.files[i]);
                    }
                    input.style.display = "none";
                    var probar = document.createElement("div");
                    probar.setAttribute("progress-bar","");
                    probar.style.height = "8px";
                    probar.style.width = "100%";
                    probar.style.margin = "0px";
                    input.parentElement.style.border = "0px";
                    var box = document.getElementById("box");
                    var probarinner = document.createElement("div");
                    probarinner.style.width = "100%";
                    probar.appendChild(probarinner);
                    input.parentElement.appendChild(probar);
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST",'../.phtml/more/readDir.mode.phtml',true);
                    xhr.send(formData);
                    btn.onclick = function(){xhr.abort();hideMsgbox(msgbox);};
                    btn.innerHTML = "取消";
                    xhr.onreadystatechange = function(){
                        if(this.readyState==4&&this.status==200){
                            var data = "['']";
                            try{
                                data = JSON.parse(this.responseText);
                            }catch(e){
                                no_err = false
                            }
                            var no_err = false;
                            var err_text = "";
                            for(var i=0;i<data.length;i++){
                                if(data[i]==""){
                                    no_err = true;
                                }else{
                                    err_text = "上传（部分）文件时出现一下错误。<br />" + data[i] + "<br />";
                                }
                            }
                            box.style.display = "none";
                            if(no_err){
                                hideMsgbox(msgbox);
                                absGoTo(meroot.substring(0,meroot.length-1));
                            }else{
                                showMsgbox(msgbox,'<h3 style="margin-bottom:5px;width:100%">上传文件时出现错误</h3><p>上传单个或多个文件出现以下错误</p><style> div.asbox_con{margin-bottom:5px;} div.asbox_con:last-child{margin-bottom:0px;}</style><div class="line" style="margin-top: 5px;"></div><p>' + this.responseText + '</p><div class="line" style="margin-top: 5px;"></div><a class="btn" right="" onclick="hideMsgbox(this.parentElement.parentElement)">好的</a>');
                            }
                        }else if(this.status==0){
                            alert("没有连接网络，请确保联网后再试一次。");
                        }
                    }
                }else{
                    hideMsgbox(msgbox);
                }
            }
        }

        function deleteFilesFromTable(){
            var d = confirm("真的要删除所有选中的文件吗？删除后不可恢复。");
            if(d==true){
                var files = document.getElementById("files_table").getAttribute("data");
                if(files!=""&&files!=null&&typeof files!="undefined"){
                    var arr_files = files.split(":");
                    for(var i=0;i<arr_files.length;i++){
                        newXMLHttpRequest("POST","../.phtml/more/readDir.mode.phtml",'key=delete&path=' + meroot + arr_files[i] + '&prlg=allow',function(rspt){
                            absGoTo(meroot.substring(0,meroot.length-1));
                        },function(){
                            alert("没有连接网络，请确保联网后再试一次。");
                        });
                    }
                }
            }
        }

        function cFiles(){
            var table = document.getElementById("files_table");
            if(table.getAttribute("data")!=""){
                var newPath = prompt("要复制到的文件路径",meroot);
                newXMLHttpRequest("POST","../.phtml/more/readDir.mode.phtml","key=copy&oldPath=" + meroot + "&files=" + table.getAttribute("data") + "&newPath=" + newPath,function(rspt){
                    if(rspt.indexOf("code: 3")<0){
                        absGoTo(meroot.substring(0,meroot.length-1));
                    }else{
                        alert("系统找不到指定的路径");    
                    }
                },function(err){
                    alert("没有连接网络，请确保联网后再试一次。");
                });
            }else{
                alert("没有选中任何文件");
            }
        }

        function mFiles(){
            var table = document.getElementById("files_table");
            if(table.getAttribute("data")!=""){
                var newPath = prompt("要移动到的文件路径",meroot);
                newXMLHttpRequest("POST","../.phtml/more/readDir.mode.phtml","key=move&oldPath=" + meroot + "&files=" + table.getAttribute("data") + "&newPath=" + newPath,function(rspt){
                    if(rspt.indexOf("code: 3")<0){
                        absGoTo(meroot.substring(0,meroot.length-1));
                    }else{
                        alert("系统找不到指定的路径");    
                    }
                },function(err){
                    alert("没有连接网络，请确保联网后再试一次。");
                });
            }else{
                alert("没有选中任何文件");
            }
            
        }

        function new_folder(){
            var msgbox = document.getElementsByClassName("MsgBox")[0];
            showMsgbox(msgbox,'<h3 style="margin-bottom:5px;width:100%">添加文件夹</h3><p>填写文件夹名称</p><style> div.asbox_con{margin-bottom:5px;} div.asbox_con:last-child{margin-bottom:0px;}</style><div class="line" style="margin-top: 5px;"></div><div class="asbox_con" style="width:calc(100% - 2px);"><p tips="">&nbsp;文件夹名称</p><input class="asbox" onfocus="boxstyle(this.parentElement,1)" onblur="boxstyle(this.parentElement,0)" placeholder="文件夹名称" autocomplete="off"><p class="r" style="display:none;color:red">&nbsp;不能包括 \\ * / ? < > : | " \' ,</p></div><div class="line" style="margin-top: 5px;"></div><a class="btn" right="" onclick="hideMsgbox(this.parentElement.parentElement)">取消</a><a class="btn" right="">确认</a>');
            var input = msgbox.children[0].getElementsByTagName("input")[0];
            var btn = msgbox.children[0].lastElementChild;
            input.onkeydown = function(a){
                var e = a || window.event;
                var illegal_char = "\\*/?<>:|\"',";
                if(illegal_char.indexOf(e.key)>=0){
                    e.preventDefault();
                    msgbox.getElementsByClassName("r")[0].style.display = "block";
                    window.setTimeout(function(){
                        msgbox.getElementsByClassName("r")[0].style.display = "none";
                    },3000);
                }
                if(e.keyCode==13||e.keyCode==10){
                    btn.onclick();
                }
            }
            btn.onclick = function(){
                newXMLHttpRequest("POST",'../.phtml/more/readDir.mode.phtml','key=mkdir&path=' + meroot + input.value,function(rspt){
                    absGoTo(meroot.substring(0,meroot.length-1));
                    hideMsgbox(msgbox);
                },function(err){
                    netFatal(err);
                });
            }
        }

        function hideRes(){
            var view_panel = document.getElementById("view_panel");
            var preview_con = document.getElementById("preview_con");
            var view_box = document.getElementById("view_box");
            view_panel.style.zIndex = 0;
            view_panel.style.display = "none";
            preview_con.style.zIndex = 0;
            preview_con.style.display = "none";
            document.body.removeAttribute("style");
            view_box.children[0].style.display = "block";
            view_box.children[0].style.margin = "0px auto";
            if(view_box.children[1]!=null&&typeof view_box.children[1].outerHTML !="undefined"){
                view_box.children[1].outerHTML = "";
            }
            view_panel.removeAttribute("text-mode");
            var a = view_panel.children[0].children[0].children[1].children[0];
            a.removeAttribute("download");
            a.removeAttribute("href");
            a.onclick = function(){};
            history.pushState("","","#"+meroot);
        }

        function showWait(){
            document.getElementsByClassName("waitDiv")[0].style.top = "0px";
        }

        function hideWait(){
            document.getElementsByClassName("waitDiv")[0].style.top = "-24px";
        }

        function hideFileUploader(msgbox){
            hideMsgbox(msgbox);
            var box = document.getElementById("box");
            box.style.display = "block";
            box.onclick = function(){
                showMsgbox(document.getElementsByClassName("MsgBox")[1]);
                box.style.display = "none";
            }
        }

        function exit(){
            newXMLHttpRequest('POST','../.phtml/vrfylogin.php','direct=adminLogout',function(){
                window.location = "http://"+location.hostname+"/db.cn/admin";
            },function(stobj){
                netFatal(stobj);
            });
        }

        function hideMsg(){
            //empty
        }

        
        function netFatal(stObj){
            var msgbox = document.getElementsByClassName('MsgBox')[0];
            var advice = "";
            if(stObj.status==0){
                advice="请确保您已经联网";
            }else if(stObj.status==403){
                advice="请确保您有权限访问此页面";
            }else if(stObj.status==404||stObj.status==500){
                advice="请确保所访问路径没有错误";
            }
            showMsgbox(msgbox,'<h3 style="width:100%">网络错误</h3><p>访问网络时遇到错误，页面返回代码：' + stObj.status + '，' + advice + '。</p><div class="line" style="margin-top: 5px;"></div><a class="btn" onclick="hideMsgbox(this.parentElement.parentElement)" right>好的</a>');
            var form = document.getElementById("form0");
            var submit0 = document.getElementById("submit0");
            eulockForm(1,form,submit0);
        }

        function eulockForm(eu,form,button){
            var input = form.getElementsByTagName("input");
            if(eu){
                for(var i=0;i<input.length;i++){
                    input[i].removeAttribute("disabled");
                }
                if(button!=null&&typeof button!="undefined"){
                    button.innerHTML = "继续";
                    button.removeAttribute("disabled","");
                }
            }else{
                for(var i=0;i<input.length;i++){
                    input[i].setAttribute("disabled","");
                }
                if(button!=null&&typeof button!="undefined"){
                    button.innerHTML = "<span class='wait' style='width:11px;background-color:transparent;filter:invert(1)'></span>";
                    button.setAttribute("disabled","");
                }
            }
        }

        var cstyle = null;
        var ihtml = null;

        function loadPage(href,post,extraFn){
            current_step = 0;
            //start init
            var css = "css/" + href.substr(0,href.length-4) + "css";
            var istyle = document.createElement("style");
            showWait();
            newXMLHttpRequest("POST",css,post,function(rspt){
                istyle.innerHTML = rspt;
                newXMLHttpRequest("POST",href,post,function(rspt){
                    ihtml = rspt;
                    if(cstyle==null){
                        document.body.appendChild(istyle);
                        cstyle = istyle;
                    }else{
                        cstyle.innerHTML = istyle.innerHTML;
                    }
                    var sec = document.getElementById("sect");
                    sec.innerHTML = ihtml;
                    if(extraFn!=null){
                        extraFn();
                    }
                    hideWait();
                },function(){
                    alert("没有连接网络，请确保联网后再试一次。");
                    hideWait();
                });
            },function(){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
            });
        }

        var global_data = new Object();
        var global_title = "";
        var global_type = 0;

        function showCon(str){
            newXMLHttpRequest("POST","../.phtml/admin.php","adminkey=viewconid&id=" + str,function(rspt){
                //identify category by first property
                var obj = JSON.parse(rspt)[0];
                global_data = obj;
                var i = 0;
                var property = "";
                var title = "";
                var data = JSON.parse(obj["object"]);
                for(var d in data){
                    if(i!=0){
                        break;
                    }
                    property = d;
                    i++;
                }
                var index = 0;
                var pages = ["book.i.html","author.i.html","list.i.html"];
                if(property=="book_name"){
                    index = 0;
                    title="编辑书籍“";
                }else if(property=="author_name"){
                    index = 1;
                    title="编辑作者“";
                }else if(property=="list_name"){
                    index = 2;
                    title="编辑书单“";
                }
                global_type = index;
                title += decodeText(data[property]) + "”";
                global_title = title;
                title += "<font>&nbsp;- 审核模式</font>";
                showWait();
                loadPage(pages[index],"id=" + obj.conid,function(){
                    showViewPanel(title);
                    hideWait();
                    if(document.getElementById("but_continue")!=null){
                        setBtn("but_continue",function(){passData();},1);
                        setBtn("but_ignore",function(){ignoreCon();},1);
                    }
                    setBtn("but_cancel",function(){hideRes();},1);
                });
            },function(err){
                alert("没有连接网络，请确保联网后再试一次。");
            });
        }

        var global_change_object = new Object();

        function setBtn(btnid,fn,enabled){
            var btn = document.getElementById(btnid);
            if(enabled){
                btn.removeAttribute("disabled");
                btn.onclick = function(){
                    fn();
                }
            }else{
                btn.setAttribute("disabled","");
                btn.onclick = null;
            }
        }

        function passData(){
            showWait();
            setBtn("but_continue",null,0);
            setBtn("but_ignore",null,0);
            newXMLHttpRequest("POST","../.phtml/admin.php","adminkey=merge&type=" + global_type.toString() + "&id=" + global_data.conid,function(rspt){
                hideWait();
                var obj = JSON.parse(rspt);
                var msgbox = document.getElementsByClassName("MsgBox")[0];
                var addhtml = "";
                var k = "";
                var obj2 = new Object();
                //display what data are changed in this verification
                if(global_type==0){
                    k = "书籍";
                }else if(global_type==1){
                    k = "作者";
                }else if(global_type==2){
                    k = "书单";
                }
                if(obj.id==""){
                    addhtml+='<div class="asbox_con" edit><p console="">&nbsp;执行动作</p><div class="asbox">添加' + k + '</div></div>'
                }else{
                    addhtml+='<div class="asbox_con" edit><p console="">&nbsp;执行动作</p><div class="asbox">编辑' + k + '</div></div>'
                }
                var arr = new Object();
                var new_arr = new Object();
                switch(global_type){
                    case 0:
                        arr.label = typeof obj.book_label=="undefined"||obj.book_label==""?[]:obj.book_label;
                        arr.authorid = typeof obj.author_name=="undefined"||obj.author_name==""?[]:obj.author_name;
                        //working out html
                        var phtml = "<p>标签ID</p>";
                        var o = 0;
                        var l = 0;
                        new_arr["label"] = new Object();
                        for(var k in arr.label){
                            if(k!=""&&arr.label[k]!=""){
                                var aids = arr.label[k].split(":");
                                new_arr.label[k] = aids[0];
                                var tmphtml = "";
                                for(var j=0;j<aids.length;j++){
                                    if(aids[j]!=""){
                                        tmphtml += "<option>" + aids[j] + "</option>";
                                    }
                                }
                                o++;
                                phtml += '<div class="asbox_con"><p>&nbsp;' + k + '的ID</p><select class="selbox" ori="' + k + '" onfocus="boxstyle(this.parentElement,1);" onblur="boxstyle(this.parentElement,0);" onchange="boklblDataChg(this)">' + tmphtml + '</select><span class="sel" onclick="this.parentElement.children[0].focus();" style="bottom: 0px;right: 4px">⇲</span></div>';
                            }
                        }
                        if(o==0){
                            phtml = "";
                        }
                        var lhtml = "";
                        new_arr.authorid = new Object();
                        for(var k in arr.authorid){
                            if(k!=""&&arr.authorid[k]!=""){
                                var aids = arr.authorid[k].split(":");
                                new_arr.authorid[k] = aids[0];
                                var tmphtml = "";
                                for(var j=0;j<aids.length;j++){
                                    if(aids[j]!=""){
                                        tmphtml += "<option>" + aids[j] + "</option>";
                                    }
                                }
                                l++;
                                lhtml += '<div class="asbox_con"><p>&nbsp;' + k + '的ID</p><select class="selbox" ori="' + k + '" onfocus="boxstyle(this.parentElement,1);" onblur="boxstyle(this.parentElement,0);" onchange="bokaurDataChg(this)">' + tmphtml + '</select><span class="sel" onclick="this.parentElement.children[0].focus();" style="bottom: 0px;right: 4px">⇲</span></div>';
                            }
                        }
                        if(l==0){
                            lhtml = "";
                        }
                        if(o!=0){
                            addhtml += '<div class="line" style="margin-top: 5px;"></div>';
                            addhtml += phtml;
                        }
                        if(l!=0){
                            addhtml += '<div class="line" style="margin-top: 5px;"></div><p>作者ID</p>';
                            addhtml += lhtml;
                        }
                        break;
                    case 1:
                        //alter the data in bokinfo instead those in aurinfo
                        arr.bookid = typeof obj.books=="undefined"||obj.books==""?[]:obj.books;
                        //working out html
                        var phtml = "<p>书籍ID</p>";
                        var o = 0;
                        new_arr["bookid"] = new Object();
                        for(var k in arr.bookid){
                            if(k!=""&&arr.bookid[k]!=""){
                                var aids = arr.bookid[k].split(":");
                                new_arr.bookid[k] = aids[0];
                                var tmphtml = "";
                                for(var j=0;j<aids.length;j++){
                                    if(aids[j]!=""){
                                        tmphtml += "<option>" + aids[j] + "</option>";
                                    }
                                }
                                o++;
                                phtml += '<div class="asbox_con"><p>&nbsp;<i>' + k + '</i>的ID</p><select class="selbox" ori="' + k + '" onfocus="boxstyle(this.parentElement,1);" onblur="boxstyle(this.parentElement,0);" onchange="aurDataChg(this)">' + tmphtml + '</select><span class="sel" onclick="this.parentElement.children[0].focus();" style="bottom: 0px;right: 4px">⇲</span></div>';
                            }
                        }
                        if(o!=0){
                            addhtml += '<div class="line" style="margin-top: 5px;"></div>';
                            addhtml += phtml;
                        }
                        break;
                    case 2:
                        arr.label = typeof obj.label_name=="undefined"||obj.label_name==""?[]:obj.label_name;
                        arr.bookid = typeof obj.book_name=="undefined"||obj.book_name==""?[]:obj.book_name;
                        var phtml = "<p>标签ID</p>";
                        var o = 0;
                        new_arr["label"] = new Object();
                        for(var k in arr.label){
                            if(k!=""&&arr.label[k]!=""){
                                var aids = arr.label[k].split(":");
                                new_arr.label[k] = aids[0];
                                var tmphtml = "";
                                for(var j=0;j<aids.length;j++){
                                    if(aids[j]!=""){
                                        tmphtml += "<option>" + aids[j] + "</option>";
                                    }
                                }
                                o++;
                                phtml += '<div class="asbox_con"><p>&nbsp;' + k + '的ID</p><select class="selbox" ori="' + k + '" onfocus="boxstyle(this.parentElement,1);" onblur="boxstyle(this.parentElement,0);" onchange="boklblDataChg(this)">' + tmphtml + '</select><span class="sel" onclick="this.parentElement.children[0].focus();" style="bottom: 0px;right: 4px">⇲</span></div>';
                            }
                        }
                        phtml += '<div class="line" style="margin-top: 5px;"></div><p>书籍ID</p>';
                        if(o==0){
                            phtml = "";
                        }
                        new_arr.bookid = new Object();
                        for(var k in arr.bookid){
                            if(k!=""&&arr.bookid[k]!=""){
                                var aids = arr.bookid[k].split(":");
                                new_arr.bookid[k] = aids[0];
                                var tmphtml = "";
                                for(var j=0;j<aids.length;j++){
                                    if(aids[j]!=""){
                                        tmphtml += "<option>" + aids[j] + "</option>";
                                    }
                                }
                                o++;
                                phtml += '<div class="asbox_con"><p>&nbsp;<i>' + k + '</i> 的ID</p><select class="selbox" ori="' + k + '" onfocus="boxstyle(this.parentElement,1);" onblur="boxstyle(this.parentElement,0);" onchange="aurDataChg(this)">' + tmphtml + '</select><span class="sel" onclick="this.parentElement.children[0].focus();" style="bottom: 0px;right: 4px">⇲</span></div>';
                            }
                        }
                        if(o!=0){
                            addhtml += '<div class="line" style="margin-top: 5px;"></div>';
                            addhtml += phtml;
                        }
                        break;
                }
                global_change_object = new_arr;
                //get the raw data of the contribution
                //and let admin to select himself/herself;
                var endhtml = '<div class="line" style="margin-top: 5px;"></div>\
                <a class="btn" onclick="collectData(this.parentElement.parentElement)" right>确认</a>\
                <a class="btn" onclick="cancelCol(this.parentElement.parentElement)" right>取消</a>';
                var HTML = '<h3 style="width:100%">数据归档检查</h3><p style="width:100%">请确认此次信息提交的属性，并确保信息无误。</p>\
                <div class="line" style="margin-top: 5px;"></div>';
                HTML += addhtml + endhtml;
                var msgbox = document.getElementsByClassName("MsgBox")[0];
                showMsgbox(msgbox,HTML);
            },function(){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
                setBtn("but_continue",function(){passData();},1);
                setBtn("but_ignore",function(){ignoreCon();},1);
            });
        }

        function ignoreCon(){
            var msgbox = document.getElementsByClassName('MsgBox')[0];
            var HTML = '<h3 style="width:100%">是否确认忽略此审核？</h3><p style="width:100%">如果要忽略此审核，按‘确认’即可；如果需要将修改意见提交给用户，请在下面的文字框中写入您的建议，并点击按钮‘将建议发送给贡献者并确认忽略’。</p><div class="line" style="margin-top: 5px;"></div>\
            <div class="asbox_con" edit="" style="margin:5px 0 0 0;overflow:hidden"><p console>&nbsp;修改建议*&nbsp;</p><textarea class="asbox" onfocus="boxstyle(this.parentElement,1)" onblur="boxstyle(this.parentElement,0)" id="advice"></textarea></div><div class="line" style="margin-top: 5px;"></div>\
            <a class="btn" right>确认</a>\
            <a class="btn" right>将建议发送给贡献者并确认忽略</a>\
            <a class="btn" onclick="cancelCol(this.parentElement.parentElement)" right>取消</a>';
            showMsgbox(msgbox,HTML);
            document.getElementsByClassName("btn")[0].onclick = function(){
                //directly ignore the contribution
                newXMLHttpRequest('POST','../.phtml/admin.php','adminkey=ignoreCon&id='+global_data.conid,function(rspt){
                    showMsgbox(msgbox,'<h3 style="width:100%">信息已经录入数据库。</h3><p style="width:100%">信息已经录入数据库。</p><div class="line" style="margin-top: 5px;"></div><a class="btn" onclick="hideMsgbox(this.parentElement.parentElement)" right>好的</a>');
                    hideMsgbox(msgbox,3000);
                    hideRes();
                    hideWait();
                    setBtn("but_continue",function(){passData();},1);
                    setBtn("but_ignore",function(){ignoreCon();},1);
                    showContributionTable();
                },function(){
                    alert("没有连接网络，请确保联网后再试一次。");
                    hideWait();
                    setBtn("but_continue",function(){passData();},1);
                    setBtn("but_ignore",function(){ignoreCon();},1);
                });
            };
            document.getElementsByClassName("btn")[1].onclick = function(){
                //sent advice and ignore the case
                var text = encodeText(document.getElementById("advice").value);
                newXMLHttpRequest('POST','../.phtml/admin.php','adminkey=ignoreCon&id='+global_data.conid+"&advice="+text,function(rspt){
                    showMsgbox(msgbox,'<h3 style="width:100%">信息已经录入数据库。</h3><p style="width:100%">信息已经录入数据库。</p><div class="line" style="margin-top: 5px;"></div><div class="line" style="margin-top: 5px;"></div><a class="btn" onclick="hideMsgbox(this.parentElement.parentElement)" right>好的</a>');
                    hideMsgbox(msgbox,3000);
                    hideRes();
                    hideWait();
                    setBtn("but_continue",function(){passData();},1);
                    setBtn("but_ignore",function(){ignoreCon();},1);
                    showContributionTable();
                },function(){
                    alert("没有连接网络，请确保联网后再试一次。");
                    hideWait();
                    setBtn("but_continue",function(){passData();},1);
                    setBtn("but_ignore",function(){ignoreCon();},1);
                });
            };
            
        }

        function aurDataChg(obj){
            global_change_object.bookid[obj.getAttribute("ori")] = obj.item(obj.selectedIndex).innerText;
        }

        function boklblDataChg(obj){
            global_change_object.label[obj.getAttribute("ori")] = obj.item(obj.selectedIndex).innerText;
        }

        function bokaurDataChg(obj){
            global_change_object.authorid[obj.getAttribute("ori")] = obj.item(obj.selectedIndex).innerText;
        }

        function cancelCol(msgbox){
            var but = document.getElementById("but_continue");
            hideMsgbox(msgbox);
            setBtn("but_continue",function(){passData();},1);
            setBtn("but_ignore",function(){ignoreCon();},1);
        }

        function collectData(msgbox){
            var but = document.getElementById("but_continue");
            //add function to scan for bookid
            //BELOW function to add to aurid
            var data = strJson(global_change_object);
            var scmd = "";
            if(global_type==0){
                scmd = "recordBok";
            }else if(global_type==1){
                scmd = "recordAur";
            }else if(global_type==2){
                scmd = "recordBkl";
            }
            showWait();
            newXMLHttpRequest('POST','../.phtml/admin.php','adminkey=' + scmd + '&conid=' + global_data.conid + "&dynData=" + data,function(rspt){
                showMsgbox(msgbox,'<h3 style="width:100%">信息已经录入数据库。</h3><p style="width:100%">信息已经录入数据库。</p><div class="line" style="margin-top: 5px;"></div><div class="line" style="margin-top: 5px;"></div><a class="btn" onclick="hideMsgbox(this.parentElement.parentElement)" right>好的</a>');
                hideMsgbox(msgbox,3000);
                hideRes();
                hideWait();
                setBtn("but_continue",function(){passData();},1);
                setBtn("but_ignore",function(){ignoreCon();},1);
                showContributionTable();
            },function(){
                alert("没有连接网络，请确保联网后再试一次。");
                hideWait();
                setBtn("but_continue",function(){passData();},1);
                setBtn("but_ignore",function(){ignoreCon();},1);
            });
        }

        function showViewPanel(title){
            var pan = document.getElementById("preview_con");
            if(title!=null){
                pan.children[0].children[0].children[0].innerHTML = title;
            }
            pan.style.zIndex = 2;
            pan.style.display = "block";
            document.body.style.overflow = "hidden";
            pan.children[1].scrollTo(0,0);
        }

        function adminSel(num){
            localStorage.setItem(navigator.platform + "_db_adminPage_item",num);
            var con = document.getElementById("adminCon");
            var tabs = con.children[0].children[0].children;
            var content = con.children[0].children;
            for(var i=0;i<content.length-1;i++){
                if(num==i){
                    tabs[i].setAttribute("selected","");
                    content[i+1].style.display = "block";
                }else{
                    tabs[i].removeAttribute("selected");
                    content[i+1].style.display = "none";
                }
            }
        }
    </script>
</html>